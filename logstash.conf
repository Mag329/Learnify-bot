input {
  tcp {
    port => 5000
    codec => json_lines {
      # Добавляем target, чтобы избежать конфликтов с ECS
      target => "bot_log"
    }
  }
}

filter {
  # Если используем target, нужно скопировать поля на верхний уровень
  if [bot_log] {
    # Копируем все поля из bot_log в корень события
    mutate {
      copy => {
        "[bot_log][message]" => "message"
        "[bot_log][level]" => "level"
        "[bot_log][logger]" => "logger"
        "[bot_log][module]" => "module"
        "[bot_log][function]" => "function"
        "[bot_log][line]" => "line"
        "[bot_log][process_id]" => "process_id"
        "[bot_log][thread_id]" => "thread_id"
        "[bot_log][bot_version]" => "bot_version"
        "[bot_log][environment]" => "environment"
        "[bot_log][user]" => "user"
        "[bot_log][action_type]" => "action_type"
        "[bot_log][action_data]" => "action_data"
        "[bot_log][processing_time_ms]" => "processing_time_ms"
      }
    }
    
    # Удаляем bot_log после копирования
    mutate {
      remove_field => ["bot_log"]
    }
  }
  
  # Убеждаемся, что @timestamp правильный
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
    timezone => "UTC"
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "learnify-logs-%{+YYYY.MM.dd}"
  }
  
  # Для отладки (можно закомментировать после настройки)
  stdout { 
    codec => rubydebug 
  }
}